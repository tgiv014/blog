<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Docker & ZFS On Debian - mntn.dev</title><meta name=generator content="Hugo 0.119.0"><link rel=stylesheet href=/styles.css></head><body class="antialiased bg-amber-100 w-full"><div class="bg-amber-50 flex flex-col items-center min-h-screen mx-auto md:max-w-4xl border-x-2 border-stone-700"><header class="w-full px-8 border-b-2 border-stone-700"><nav class="relative flex items-end justify-between flex-wrap py-4 text-stone-900 text-3xl md:text-4xl"><a href=https://mntn.dev/ class="flex items-center hover:underline decoration-amber-400 font-extrabold">mntn.dev</a><ul id=nav-menu class="flex w-full sm:w-auto mt-2 sm:mt-0 space-x-6 text-xl"><li><a href=https://mntn.dev/projects/ class="hover:underline decoration-amber-400 tracking-tight">Projects</a></li><li><a href=https://mntn.dev/posts/ class="hover:underline decoration-amber-400 tracking-tight">Posts</a></li></ul></nav></header><main class="flex-1 w-full"><article class="justify-self-center mt-4"><div class="border-b-2 border-stone-700 px-8 lg:py-4"><h1 class="text-3xl md:text-4xl text-stone-900 mb-2">Docker & ZFS On Debian</h1><h3 class="text-stone-900 mb-2 text-sm md:text-lg">October 3, 2020</h3></div><div class="border-b-2 border-stone-700 px-8 mt-4 pb-4"><div class="max-w-none
prose prose-sm prose-stone md:prose-lg
prose-pre:px-8 prose-pre:-mx-8 prose-pre:rounded-none
prose-blockquote:border-l-8
prose-img:mx-auto
prose-figcaption:text-center
hover:prose-a:decoration-amber-400"><figure><img src=zfs_docker_debian.png></figure><h1 id=howd-we-get-here>How&rsquo;d we Get Here&mldr;</h1><p>A while back, I snagged a Dell R710 from Ebay for $350 delivered. This thing is a virtualization <em>monster</em>. 8 cores and 144GB of ECC RAM, perfect for filling with bhyve virtual machines on FreeNAS. This setup worked great for me until I became interested in Docker containers. FreeNAS just doesn&rsquo;t support a docker environment, so let&rsquo;s build something from the ground up and document the process.</p><h1 id=constraints>Constraints</h1><ul><li>Must use ZFS (no need for ZFS root)</li><li>Native docker support</li><li>Lightweight (no GUI, unnecessary package systems *cough cough snaps*, etc.)</li></ul><p>With these constraints, we know we absolutely must use Linux and we would really like a distro that has openzfs in its package control. In the past I&rsquo;ve used Ubuntu Server and ubuntu 16.04 has zfs available as a package, but I want to avoid snaps like the plague. Because of this, I&rsquo;m going to use Debian.</p><h1 id=initial-setup>Initial Setup</h1><p>First things first, we&rsquo;re going to shut down the server and remove every drive but our desired boot drive. FreeNAS uses a flash drive as its root storage, but debian doesn&rsquo;t quite support that. In my case, I&rsquo;m going to use an old 120GB SSD in an optical drive caddy in place of the server&rsquo;s disk drive. It&rsquo;s easy enough to complete the guided install, and Debian has some pretty good installation literature:</p><ul><li><a href=https://www.debian.org/releases/stable/i386/index.en.html>Installation Guide - Long</a></li><li><a href=https://www.debian.org/releases/stable/i386/apa.en.html>Installation Howto - Short</a></li></ul><p>I do have a few gotchas during the guided install:</p><ul><li>Some NICs require closed-source firmware to operate. The NIC in my R710 is one of those, so I had to use the <a href=https://cdimage.debian.org/cdimage/unofficial/non-free/cd-including-firmware/current/>non-free debian image</a>.</li><li>Guided partitioning failed for my install. I suspect that this is because it was trying to make a gigantic swap partition to match the 144GB of RAM. I decided not to use a swap partition and partition the entire SSD as <code>/</code>.</li><li>I avoided giving root a password. Instead, I have an administrator user with sudo access.</li><li>I did not install any desktop environments or X server components.</li><li>Don&rsquo;t forget to select openssh!</li></ul><h1 id=post-install>Post-Install</h1><p>Now that we have a fully running debian system, let&rsquo;s change a few things. Pop all your drives back in and ssh in.</p><p>Let&rsquo;s gear up to use ssh without a password, starting by setting up private key authentication. If you&rsquo;re on linux, you&rsquo;ve got it easy: <code>$ ssh-copy-id $USER@$HOST</code>. On Windows, I find it easiest to manually copy the contents of <code>%HOMEPATH%\.ssh\id_rsa.pub</code> to <code>~/.ssh/authorized_keys</code> on my server. If you don&rsquo;t have an <code>~/.ssh/id_rsa.pub</code> or <code>%HOMEPATH%\.ssh\id_rsa.pub</code>, you better generate an ssh key with <code>$ ssh-keygen</code>.</p><p>Once your public key is copied in, it&rsquo;s a good idea to exit your ssh session and attempt to login with private key auth. If you don&rsquo;t need a password, you&rsquo;re on the right path. Time to disable password authentication. In <code>/etc/ssh/sshd_config</code>, find the lines containing the following keys, uncomment them and make sure they&rsquo;re set to <code>no</code>.</p><pre tabindex=0><code>PasswordAuthentication no
ChallengeResponseAuthentication no
PermitRootLogin no
UsePAM no
</code></pre><p>Now you can reload sshd and bask in paswordless security strong enough to leave exposed publicly. <code>$ sudo /etc/init.d/sshd reload</code></p><h1 id=zfs-time>ZFS Time</h1><p>Debian makes this one super easy. Check the <a href=https://wiki.debian.org/ZFS>official ZFS Debian Wiki Page</a> for more info. Use the following commands to install ZFS on Debian.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo apt update
</span></span><span style=display:flex><span>$ sudo apt install linux-headers-<span style=color:#b8bb26>`</span>uname -r<span style=color:#b8bb26>`</span>
</span></span><span style=display:flex><span>$ sudo apt install -t buster-backports dkms sol-dkms
</span></span><span style=display:flex><span>$ sudo apt install -t buster-backports zfs-dkms zfsutils-linux
</span></span></code></pre></div><p>It may take a little while to run the dkms build, and it may throw a few warnings. They do not specifically recommend a reboot on the Debian Wiki, but it&rsquo;s never a bad idea when dealing with kernel modules.</p><p>Just for grins, if you happen to be installing on a system that used to run FreeNAS, you can try to import your old pool with <code>$ sudo zpool import</code>. You&rsquo;re likely to see <code>action: The pool can be imported using its name or numeric identifier and the '-f' flag.</code>. You can force the import by running <code>$ sudo zpool import -f $POOLNAME</code>.</p><p>If you&rsquo;re starting fresh, now is the time to make your first zfs pool. I&rsquo;m in a bit of a hard drive shortage, so for testing&rsquo;s sake I will be doing a stripe pool with two 500GB hard drives. ZFS uses disk IDs or paths to reference disks instead of /dev/sdX paths. You can figure out which disk is which with the following commands:</p><pre tabindex=0><code>$ ls -l /dev/disk/by-id
$ ls -l /dev/disk/by-path
$ lsblk -o NAME,SIZE,MODEL,VENDOR
</code></pre><p>With the device IDs in hand, I&rsquo;ll make a zpool with:</p><pre tabindex=0><code>$ sudo zpool create tank ata-ST9500325AS_6VESPM0A ata-ST9500325AS_6VESRNXY
</code></pre><h1 id=docker-install>Docker Install</h1><p>This is essentially a summary of the <a href=https://docs.docker.com/engine/install/debian/>Docker Docs for Debian</a>.</p><ol><li>Update apt and install required packages:</li></ol><pre tabindex=0><code>$ sudo apt update
$ sudo apt install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
</code></pre><ol start=2><li>Get Docker&rsquo;s GPG key:</li></ol><pre tabindex=0><code>$ curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
</code></pre><p>You can verify you have the correct key as follows:</p><pre tabindex=0><code>$ sudo apt-key fingerprint 0EBFCD88
pub   4096R/0EBFCD88 2017-02-22
      Key fingerprint = 9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88
uid                  Docker Release (CE deb) &lt;docker@docker.com&gt;
sub   4096R/F273FCD8 2017-02-22
</code></pre><ol start=3><li>Use the following command to set up Docker stable.</li></ol><pre tabindex=0><code>$ sudo add-apt-repository \
   &#34;deb [arch=amd64] https://download.docker.com/linux/debian \
   $(lsb_release -cs) \
   stable&#34;
</code></pre><ol start=4><li>Finally, install docker!</li></ol><pre tabindex=0><code>$ sudo apt update
$ sudo apt install docker-ce docker-ce-cli containerd-io
</code></pre><ol start=5><li>If you want to allow other users to run docker commands, you can set that up <a href=https://docs.docker.com/engine/install/linux-postinstall/>as follows</a>:</li></ol><pre tabindex=0><code>$ sudo groupadd docker
$ sudo usermod -aG docker $USER
</code></pre><p>Log out and back in</p><ol><li>You can verify that your docker install is functional by running <code>hello-world</code></li></ol><pre tabindex=0><code>$ docker run --rm hello-world
</code></pre><h1 id=lets-hook-up-docker-and-zfs>Let&rsquo;s Hook up Docker and ZFS</h1><p>This part&rsquo;s for the adventurous. You could certainly just make a bunch of ZFS datasets with filesystem mounts and mount those in your containers for bulk storage, but that&rsquo;s no fun! Docker has a <a href=https://docs.docker.com/storage/storagedriver/zfs-driver/>ZFS storage driver</a> that will back all container, image, and volume storage with zfs. Let&rsquo;s set it up.</p><ol><li>Kill docker:</li></ol><pre tabindex=0><code>$ sudo /etc/init.d/docker stop
</code></pre><ol start=2><li>Back up /var/lib/docker just in case and then delete its contents:</li></ol><pre tabindex=0><code>$ sudo cp -au /var/lib/docker /var/lib/docker.bk
$ sudo rm -rf /var/lib/docker/*
</code></pre><ol start=3><li>Create a ZFS-backed mountpoint at <code>/var/lib/docker</code>. The official docker instructions suggest making a zpool and mounting it there, but I&rsquo;ll use a dataset since I already have a zpool configured (name <code>tank</code>).</li></ol><pre tabindex=0><code>$ sudo zfs create -o mountpoint=/var/lib/docker tank/docker
</code></pre><ol start=4><li>Tell Docker to use ZFS for its storage driver. In <code>/etc/docker/daemon.json</code>:</li></ol><pre tabindex=0><code>{
  &#34;storage-driver&#34;: &#34;zfs&#34;
}
</code></pre><ol start=5><li>Start docker back up and verify you&rsquo;re using the ZFS storage driver:</li></ol><pre tabindex=0><code>$ sudo /etc/init.d/docker start
$ docker info
Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 114
 Server Version: 19.03.11
 Storage Driver: zfs
  Zpool: tank
  Zpool Health: ONLINE
  Parent Dataset: tank/docker
  Space Used By Parent: 17283463680
  Space Available: 935802788864
  Parent Quota: no
  Compression: off
 Logging Driver: json-file
 Cgroup Driver: cgroupfs
</code></pre><h1 id=-done>🎉 Done!</h1><p>Now we have a server running Debian with Docker using ZFS-backed storage. This would be a great way to put together a NAS setup using samba or NFS with a bunch of self-hosted services. I&rsquo;ll be using Docker to host a home assistant instance with nginx sitting in front as a reverse proxy.</p></div></div></article></main><footer class="relative bottom-0 w-full p-4 text-sm text-center font-mono text-stone-700"><p>© 2023 Thomas Gorham | Made with
<a href=https://gohugo.io class="underline hover:text-amber-700">Hugo</a></p></footer></div></body></html>