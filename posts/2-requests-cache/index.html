<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Faster Backtesting with requests-cache - mntn.dev</title><meta name=generator content="Hugo 0.117.0"><link rel=stylesheet href=/styles.css></head><body class="antialiased bg-amber-50 w-full"><div class="flex flex-col items-center min-h-screen w-full"><div class=w-full><div class="mx-auto md:max-w-4xl px-8 lg:px-0"><header class=w-full><nav class="relative flex items-end justify-between flex-wrap py-4 lg:pt-8 text-stone-900 text-3xl md:text-4xl"><a href=https://mntn.dev/ class="flex items-center italic hover:underline decoration-amber-400 font-black tracking-tighter">mntn.dev</a><ul id=nav-menu class="flex w-full sm:w-auto mt-2 sm:mt-0 space-x-6 text-xl"><li><a href=https://mntn.dev/projects/ class="hover:underline decoration-amber-400 tracking-tight">Projects</a></li><li><a href=https://mntn.dev/posts/ class="hover:underline decoration-amber-400 tracking-tight">Posts</a></li></ul></nav></header></div></div><div class="flex-1 w-full"><main class="mx-auto md:max-w-4xl"><article class="justify-self-center mb-4 mt-4 sm:mt-16 mx-8 lg:mx-0"><div class="flex border-b-2 border-stone-700 mb-8 gap-2 md:gap-4"><div class="flex flex-col"><h1 class="text-3xl md:text-7xl text-stone-800 mb-2">02</h1><div class="flex-1 relative"><svg class="absolute text-stone-900 w-full h-full"><defs><pattern id="wave" x="0" y="0" width="12" height="24" patternUnits="userSpaceOnUse" patternTransform="scale(2)"><path d="M1 24H2V23H3v1H4V23H5v1H6V23H7v1H8V23H9v1h1V23h1v1h1V22H11V21h1V18H11V17h1V14H11V13h1V10H11V9h1V6H11V5h1V2H11V1h1V0H0V3H1V4H0V7H1V8H0v3H1v1H0v3H1v1H0v3H1v1H0v3H1v1zm0-2V21H2v1H1zm0-4V17H2v1H1zm0-4V13H2v1H1zm0-4V9H2v1H1zM1 6V5H2V6H1zM1 2V1H2V2H1zM2 20V19H3v1H2zm0-4V15H3v1H2zm0-4V11H3v1H2zM2 8V7H3V8H2zM2 4V3H3V4H2zM3 22V21H4v1H3zm0-4V17H4v1H3zm0-4V13H4v1H3zm0-4V9H4v1H3zM3 6V5H4V6H3zM3 2V1H4V2H3zM4 20V19H5v1H4zm0-4V15H5v1H4zm0-4V11H5v1H4zM4 8V7H5V8H4zM4 4V3H5V4H4zM5 22V21H6v1H5zm0-4V17H6v1H5zm0-4V13H6v1H5zm0-4V9H6v1H5zM5 6V5H6V6H5zM5 2V1H6V2H5zM6 20V19H7v1H6zm0-4V15H7v1H6zm0-4V11H7v1H6zM6 8V7H7V8H6zM6 4V3H7V4H6zM7 22V21H8v1H7zm0-4V17H8v1H7zm0-4V13H8v1H7zm0-4V9H8v1H7zM7 6V5H8V6H7zM7 2V1H8V2H7zM8 20V19H9v1H8zm0-4V15H9v1H8zm0-4V11H9v1H8zM8 8V7H9V8H8zM8 4V3H9V4H8zM9 22V21h1v1H9zm0-4V17h1v1H9zm0-4V13h1v1H9zm0-4V9h1v1H9zM9 6V5h1V6H9zM9 2V1h1V2H9zm1 18V19h1v1H10zm0-4V15h1v1H10zm0-4V11h1v1H10zm0-4V7h1V8H10zm0-4V3h1V4H10z" fill="currentcolor"/></pattern></defs><rect x="0" y="0" width="100%" height="100%" fill="url(#wave)"/></svg></div></div><div class=flex-1><h2 class="text-3xl md:text-4xl text-stone-900">Faster Backtesting with requests-cache</h2><h3 class="font-mono text-base md:text-lg text-stone-800 mb-2">February 3, 2021</h3></div></div><div class="prose prose-sm max-w-none md:prose-lg prose-p:text-stone-900 prose-headings:text-stone-900 prose-p:indent-12 prose-pre:rounded-xl prose-pre:bg-stone-800 prose-blockquote:border-l-8 prose-img:mx-auto prose-figcaption:text-center hover:prose-a:decoration-amber-400 prose-hr:border-stone-300"><h1 id=the-problem>The Problem</h1><p>Lately, I&rsquo;ve been playing with algorithmic trading using <a href=https://www.backtrader.com/>Backtrader</a>, which is a spectacular tool for experimenting with algorithmic trading strategies. This hobby could be considered a problem in itself, but that&rsquo;s not today&rsquo;s topic. A strategy I&rsquo;ve been testing involves maintaining a list of S&amp;P500 stocks, ranking them by some metrics, and making a portfolio out of the top 20% or so. Essentially, a really impersonal buy-and-hold strategy.</p><p>Unfortunately, this means I need to collect data on 500 stocks over my backtesting time range (5+ years). I would really prefer to use Backtrader&rsquo;s automatic Yahoo Finance data source <code>bt.feeds.YahooFinanceData</code>, but I don&rsquo;t want to send 500+ requests to Yahoo every time I tweak a single variable. On a list of just 16 stocks, it takes ~40 seconds to query 5 years of data and run the strategy. There has to be a better way.</p><h1 id=enter-requests-cache>Enter <code>requests-cache</code>!</h1><p>Backtrader supports proxies (so we could set up a caching proxy), but under the hood, backtrader&rsquo;s <a href=https://github.com/mementum/backtrader/blob/master/backtrader/feeds/yahoo.py>Yahoo feed</a> uses the <code>requests</code> module! This means we can solve our problem without even touching a proxy service or having to set up local SSL certificates to cache HTTPS.</p><p>All we need to do is run <code>pip install requests-cache</code> and add two lines of code to the start of our Backtrader script.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>import</span> requests_cache
</span></span><span style=display:flex><span>requests_cache<span style=color:#fe8019>.</span>install_cache(<span style=color:#b8bb26>&#39;test_cache&#39;</span>, expire_after<span style=color:#fe8019>=</span><span style=color:#d3869b>3600</span>)
</span></span></code></pre></div><p>Now, requests-cache will automatically cache any requests made via the python <code>request</code> module in a file called <code>test_cache.sqlite</code>. Even HTTPS. With this little change, backtesting against 16 stocks over 5 years finishes in 10 seconds: an improvement of 75%!</p></div></article></main></div><footer class="relative bottom-0 w-full p-4 text-sm text-center font-mono text-stone-700"><p>Â© 2023 Thomas Gorham | Made with
<a href=https://gohugo.io class="underline hover:text-amber-700">Hugo</a></p></footer></div></body></html>